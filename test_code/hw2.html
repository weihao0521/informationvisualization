<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>hw2</title>
        
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.9/require.min.js"></script> 	
  <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.3.3/d3.min.js"></script>
    
    <style>
        body { font: 12px Arial;}

        path { 
            stroke: steelblue;
            stroke-width: 2;
            fill: none;
        }            
        
        .axis path,
        .axis line {
            fill: none;
            stroke: grey;
            stroke-width: 1;
            shape-rendering: crispEdges;
        }

        .brush .extent {
            stroke: #fff;
            fill-opacity: .125;
            shape-rendering: crispEdges;
        }		    
        .loader {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.8);
            text-align: center;
            z-index: 99;
            display: none;
        }
        .loader p {
            margin-top: 180px;
        }
    </style>
</head>

<body>
	    <script src="./number.js"></script>
<script type="text/javascript">
    var _container, _graphs = [];

    //chart d3 config
    var _svgContainer, _chartCanvas, _xScale, _xDomain = [Infinity, -Infinity];

    //static config
    var containerWidth = 800, containerHeight = 400;
    var margin = { top: 40, right: 50, bottom: 30, left: 60 },
    width = containerWidth - margin.left - margin.right,
    height = containerHeight - margin.top - margin.bottom;
    var logChartHeight = 100, diChartHeight = 20;
    var gap = 30;
    var color = d3.scale.category10();
	options={ container: '#container', xDim: 'DateTime' }
	_container = options.container;
	containerWidth = $(_container).width();
	width = containerWidth - margin.left - margin.right;

	_svgContainer = d3.select(_container)
		.append("svg")
		.attr("width", containerWidth)
		.attr("height", containerHeight);

	_svgContainer.append("defs").append("clipPath")
		.attr("id", "clip")
		.append("rect")
		.attr("width", width)
		.attr("height", height);

	_chartCanvas = _svgContainer
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	// set up the X Axis scale
	_xScale = d3.time.scale().range([0, width]);
	
	// set up horizental line
	var hoverLine = _chartCanvas.append('svg:line')
	.attr('class', 'hover-line')
	.attr('x1', 20).attr('x2', 20)
	.attr('y1', 2)// prevent touching x-axis line
	.attr('y2', height + 20)
	.attr('transform', 'translate(0, -20)')
	.attr('stroke-width', 1)
	.attr('stroke', 'grey')
	.attr('opacity', 1e-6);
	
	_chartCanvas.append("g")
		.attr('id', 'xAxis')
		.attr('transform', 'translate(0, -20)') // putting x-Axis into the margin area
		
	_chartCanvas.select('#xAxis').append('g')// where x-axis will be rendered
		.attr("class", "x axis");
	        var timeLegend = _chartCanvas.append('text')
            .attr('class', 'legend-time')
            .attr('x', width)
            .attr('y', -5) // push to the margin area below x-axis
            .attr('text-anchor', 'end')
            .text('time:');
			
	_svgContainer// mouse event not working on _chartCanvas
		.on('mouseover', function () {
			var mouse = d3.mouse(this);
			var mX = mouse[0] - margin.left, mY = mouse[1] - margin.top;
			if (mX > 0 && mY > 0 && mX < width){
				hoverLine.style('opacity', 1);   
			}             
			else
				hoverLine.style("opacity", 1e-6);
		})
		.on('mouseout', function () {
			hoverLine.style("opacity", 1e-6);
		})
		.on('mousemove', function () {
                var mouse = d3.mouse(this);
                var mX = mouse[0] - margin.left, mY = mouse[1] - margin.top;
                hoverLine.attr('x1', mX).attr('x2', mX);
                if (mX > 0 && mY > 0 && mX < width) { 
                    var dt = _xScale.invert(mX);
                    var nearestDateVal = moment(dt).add(7,'month').format('YYYY');
                    var graphIdswithDataAtNearestDate = ["WhiteAlone", "WhiteAloneNotHispanic", "BlackAloneOrInCombination",
                    "BlackAlone","Hispanic","AsianAloneOrInCombination","AsianAlone"];
                    if (nearestDateVal!=null) {
                        var xMoment = moment(nearestDateVal);
                        d3.selectAll('.graph').data(_graphs, function (d) { return d.id; }).each(function (d) {
                            var g = d3.select(this);
                            var str = '';                        
                            if (graphIdswithDataAtNearestDate.indexOf(d.id) >= 0) {
                                str= d.data[2013-nearestDateVal]["Value"];
                            }              
                            g.select('.legend').text(d.id + ' : ' + str);

                        });
                        var a = Number(xMoment.format('YYYY'))+ 1;
                        
                        timeLegend.text(a);
                        var moveX = _xScale(xMoment);
                        console.log(moveX);
                        hoverLine.attr('x1', moveX+10).attr('x2', moveX+10);
                    }                  
                } 
            });
	var graph = { id: 'WhiteAlone', type: 'analog', name: 'WhiteAlone', dataId: 513, yVal: ['Value'], data: WhiteAlone };
	var max = moment(dates[0]).add(1,'year').valueOf(), min = dates[dates.length - 1].valueOf(), streched = false; // assuming data is sorted
	if (min < _xDomain[0]) {
            _xDomain[0] = min;
            streched = true;
        }
        if (max > _xDomain[1]) {
            _xDomain[1] = max;
            streched = true;
        }
        if (streched) {
            _xScale.domain(_xDomain); 
        }

</script>

	    <div id="container" style="min-width: 300px;width:100%">
			<div class="loader"><p>Working...</p></div>
		</div>

</body>
</html>
